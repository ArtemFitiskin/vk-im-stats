/* 
 * vk-im-stats v0.0.1 - 2014-06-16 
 * vk.com im analytics script and tool 
 * http://github.com/ArtemFitiskin/vk-im-stats 
 * 
 * Copyright 2014 Artem Fitiskin; MIT Licensed 
 */ 

var Stat=function(){"use strict";var a={speed:3,token:!1,api:"https://api.vk.com/method/",version:"5.21",fresh:30,timestamp:+new Date,usersFields:"sex,photo_50,screen_name,city,country",selfFields:"sex,bdate,city,country,photo_50,photo_200,lists,connections,universities,schools,relation,relatives,screen_name,timezone",callback:function(){},logs:function(){}},b={out:0,timeout:0,users:[],chats:[],dchats:[],offsets:{dialogs:0,users:0,messages:{inbox:0,outbox:0},chats:0},counts:{dialogs:200,users:1e3,chats:200,messages:200},deleted:[],maybeDeleted:[]},c={vars:{firstMessage:!1},count:{dialogs:{all:0,type:{chat:0,personal:0},end:{myself:0,companion:0},fresh:0},users:{all:0,gender:{male:0,female:0,nope:0}},chats:{all:0,type:{admin:0,user:0}},messages:{all:0,type:{inbox:0,outbox:0},bytes:{inbox:0,outbox:0,all:0},deleted:0,sizes:{inbox:0,outbox:0,all:0},attachments:{inbox:0,outbox:0,all:0,type:{}}}},data:{dialogs:[],users:[],chats:[],dchats:[]}},d=function(c,d,e){var f=+new Date-b.timeout>Math.floor(1e3/a.speed)?0:Math.floor(1e3/a.speed)-(+new Date-b.timeout);setTimeout(function(){$.ajax({type:"GET",dataType:"jsonp",url:a.api+c,data:$.extend({},{access_token:a.token,v:a.version},d),beforeSend:function(){b.timeout=+new Date}}).done(function(a){if(a.error)throw new Error(a.error.error_code+", "+a.error.error_msg);e.call(null,a.response)}).fail(function(){})},f)},e=function(d){switch(d){case"user":i();break;case"dialogs":for(var e=0,m=c.data.dialogs.length;m>e;e++){var n=c.data.dialogs[e];n.chat_id?(c.count.dialogs.type.chat+=1,n.users_count?b.chats.push(n.chat_id):(b.dchats.push(n.chat_id),c.data.dchats.push(n))):(c.count.dialogs.type.personal+=1,n.id&&b.users.push(n.user_id)),a.timestamp-1e3*n.date<864e5*a.fresh&&(c.count.dialogs.fresh+=1),1===n.out?c.count.dialogs.end.myself+=1:c.count.dialogs.end.companion+=1}c.count.users.all=b.users.length,c.count.chats.all=b.chats.length,j();break;case"users":for(var o=0,p=c.data.users.length;p>o;o++){var q=c.data.users[o];switch(q.sex){case 1:c.count.users.gender.female+=1;break;case 2:c.count.users.gender.male+=1;break;default:c.count.users.gender.nope+=1}}k();break;case"chats":for(var r=0,s=c.data.chats.length;s>r;r++){var t=c.data.chats[r];t.admin_id===c.data.user.id?c.count.chats.type.admin+=1:c.count.chats.type.user+=1}l();break;case"messages":for(var u=0,v=b.maybeDeleted.length;v>u;u++)b.maybeDeleted[u]&&b.deleted.push(b.maybeDeleted[u]);c.count.messages.deleted=b.deleted.length,g();break;default:f("Начало сбора статистики"),h()}},f=function(b,c){var d=+new Date-a.timeout;c=c?Math.round(100*c)/100:!1,a.logs(d,b,c)},g=function(){f("Сборка статистики закончена"),a.callback(c)},h=function(b){var g="";b?(c.vars.firstMessage=b.firstMessage,c.data.user=b.userData,e("user")):(f("Получение общих данных пользователя"),g+='var firstMessage = API.messages.getById({"message_ids": 1}).items[0].date;',g+='var userData = API.users.get({"fields": "'+a.selfFields+'"})[0];',g+="return {",g+='"firstMessage": firstMessage,',g+='"userData": userData',g+="};",d("execute",{code:g},h))},i=function(a){if(a){a.count&&!c.count.dialogs.all&&(c.count.dialogs.all=a.count),b.offsets.dialogs+=a.items.length;for(var g=0,h=a.items.length;h>g;g++)c.data.dialogs.push(a.items[g].message);f("Получение данных о диалогах",b.offsets.dialogs/c.count.dialogs.all),b.offsets.dialogs<c.count.dialogs.all?d("messages.getDialogs",{count:b.counts.dialogs,offset:b.offsets.dialogs},i):e("dialogs")}else f("Получение данных о диалогах",0),d("messages.getDialogs",{count:b.counts.dialogs,offset:b.offsets.dialogs},i)},j=function(g){g?(b.offsets.users+=g.length,c.data.users.push.apply(c.data.users,g),f("Получение данных о собеседниках",b.offsets.users/c.count.users.all),b.offsets.users<c.count.users.all?d("users.get",{fields:a.usersFields,user_ids:b.users.slice(b.offsets.users,b.offsets.users+b.counts.users).join(",")},j):e("users")):(f("Получение данных о собеседниках",0),d("users.get",{fields:a.usersFields,user_ids:b.users.slice(b.offsets.users,b.offsets.users+b.counts.users).join(",")},j))},k=function(a){a?(b.offsets.chats+=a.length,c.data.chats.push.apply(c.data.chats,a),f("Получение данных о чатах",b.offsets.chats/c.count.chats.all),b.offsets.chats<c.count.chats.all?d("messages.getChat",{chat_ids:b.chats.slice(b.offsets.chats,b.offsets.chats+b.counts.chats).join(",")},k):e("chats")):(f("Получение данных о чатах",0),d("messages.getChat",{chat_ids:b.chats.slice(b.offsets.chats,b.offsets.chats+b.counts.chats).join(",")},k))},l=function(a){var g="";if(a){if(isNaN(a.length)){c.count.messages.type.inbox=a.inbox,c.count.messages.type.outbox=a.outbox,c.count.messages.all=a.inbox+a.outbox;for(var h=0;210412>h;h++)b.maybeDeleted.push(h)}else for(var i=0,j=a.length;j>i;i++)b.out?b.offsets.messages.outbox+=a[i].length:b.offsets.messages.inbox+=a[i].length,m(a[i]);var k=b.out?b.offsets.messages.outbox:b.offsets.messages.inbox,n=b.out?c.count.messages.type.outbox:c.count.messages.type.inbox;b.out||k!==c.count.messages.type.inbox||(b.out=1,k=0);var o=b.out?(c.count.messages.type.inbox+k)/c.count.messages.all:k/c.count.messages.all;f("Загрузка сообщений",o),n>k?(g+="var offset = "+k+";",g+="var count = "+b.counts.messages+";",g+="var i = 0;",g+="var data = [];",g+="while (i < 25) {",g+='var part = API.messages.get({"out": '+b.out+', "count": count, "offset": offset});',g+="var income = part.items.length;",g+="offset = offset + income;",g+="if (income) {",g+="data.push(part.items);",g+="i = i + 1;",g+="} else {",g+="i = 25;",g+="}",g+="};",g+="return data;",d("execute",{code:g},l)):e("messages")}else g+='return {"inbox":API.messages.get({"out": 0, "count": 0}).count,"outbox": API.messages.get({"out": 1, "count": 0}).count};',d("execute",{code:g},l)},m=function(a){for(var d=0,e=a.length;e>d;d++){var f=a[d],g=f.chat_id?b.chats.indexOf(f.chat_id):b.users.indexOf(f.user_id),h=f.chat_id?c.data.chats[g]:c.data.users[g],i=f.out?"outbox":"inbox",j=f.body.length,k=n(f.body);if(h||(g=b.dchats.indexOf(f.chat_id),h=c.data.dchats[g]),b.maybeDeleted[f.id]=!1,h.stats||(h.stats={all:0,type:{inbox:0,outbox:0},bytes:{inbox:0,outbox:0,all:0},deleted:0,sizes:{inbox:0,outbox:0,all:0},attachments:{inbox:0,outbox:0,all:0,type:{}}}),h.stats.all+=1,h.stats.type[i]+=1,c.count.messages.bytes.all+=k,c.count.messages.bytes[i]+=k,h.stats.bytes.all+=k,h.stats.bytes[i]+=k,c.count.messages.sizes.all+=j,c.count.messages.sizes[i]+=j,h.stats.sizes.all+=j,h.stats.sizes[i]+=j,f.attachments){c.count.messages.attachments.all+=f.attachments.length,c.count.messages.attachments[i]+=f.attachments.length,h.stats.attachments.all+=f.attachments.length,h.stats.attachments[i]+=f.attachments.length;for(var l=0;l<f.attachments.length;l++)c.count.messages.attachments.type.hasOwnProperty(f.attachments[l].type)||(c.count.messages.attachments.type[f.attachments[l].type]={inbox:0,outbox:0,all:0}),h.stats.attachments.type.hasOwnProperty(f.attachments[l].type)||(h.stats.attachments.type[f.attachments[l].type]={inbox:0,outbox:0,all:0}),c.count.messages.attachments.type[f.attachments[l].type].all+=1,c.count.messages.attachments.type[f.attachments[l].type][i]+=1,h.stats.attachments.type[f.attachments[l].type].all+=1,h.stats.attachments.type[f.attachments[l].type][i]+=1}}},n=function(a){a=String(a);for(var b=0,c=0;c<a.length;c++){var d=a.charCodeAt(c);b+=128>d?1:2048>d?2:65536>d?3:1<<21>d?4:1<<26>d?5:1<<31>d?6:Number.NaN}return b};return this.init=function(b,c,d){a.token=b.split("#access_token=")[1].split("&")[0],a.timestamp=+new Date,a.timeout=a.timestamp,a.callback=c,a.logs=d,f("Старт приложения"),e()},this}.apply({});